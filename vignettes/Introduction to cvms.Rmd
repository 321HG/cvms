---
title: "Introduction to cvms"
author: 
  - "Ludvig Renbo Olsen"
date: "`r Sys.Date()`"
abstract: |
  This vignette is an introduction to the package cvms.  
  Cross-validation for model selection.  
  &nbsp;  
  &nbsp;  
  Contact author at r-pkgs@ludvigolsen.dk
  &nbsp;  
  &nbsp;  
  
  -----
output: 
  rmarkdown::html_vignette:
    css: 
    - !expr system.file("rmarkdown/templates/html_vignette/resources/vignette.css", package = "rmarkdown")
    - styles.css
    fig_width: 6
    fig_height: 4
    toc: yes
    number_sections: no
  rmarkdown::pdf_document:
    highlight: tango
    number_sections: yes
    toc: yes
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{Introduction to cvms}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Attach packages

```{r warning=FALSE, message=FALSE}
library(cvms)
library(groupdata2) # fold()
library(dplyr) # %>% arrange() mutate()
library(knitr) # kable()

```

# Loading data
We will use the mtcars dataset from base R.

```{r}
require(graphics)

# Set seed for reproducibility
set.seed(3)

# Load mtcars dataset
df <- mtcars %>% 
  
  # Convert am to factor
  # and add car column
  mutate(am = as.factor(am),
         car = rownames(.)) %>% 
  
  # Fold data (see groupdata2::fold)
  fold(k = 4, cat_col = 'am') %>% 
  
  # Order by the folds column
  arrange(.folds) 

# Remove the row names
# as they are silly
rownames(df) <- NULL

df %>% head(15) %>% kable()
```

## lm()

```{r}
cross_validate(df, 'mpg~am+cyl')
```

## lmer()

```{r}
cross_validate(df, 'mpg~am+cyl+(1|disp)', REML=FALSE)
```

## glm()

```{r}
cross_validate(df, 'am~mpg+cyl', family='binomial')
```

## glmer()

```{r}
cross_validate(df, 'am~mpg+cyl+(1|disp)', 
               family='binomial', REML=FALSE)
```


## Mixing lm and lmer

```{r}
cross_validate(df, c("mpg~am", "mpg~am+(1|disp)"), REML=FALSE)
```

## Mixing glm and glmer

Notice that we get a warning message.  
If these are convergence warnings, they will be counted, so you can discard the model.  
Else you will have to read the warning messages that specifies the model and the fold where the warning was issued.  

```{r}
cross_validate(df, c("am~mpg", "am~mpg+cyl", "am~mpg+cyl+wt"), 
               family='binomial', REML=FALSE)
```


# Convergence Warnings
If we get convergence warnings while fitting our model on a fold, the values of that fold will return NA and we will count the warning (see `Convergence Warnings` in the output).  
The model and fold that didn't converge are warned about.  
Whenever you are comparing models, consider discarding the ones with convergence warnings.  

```{r}
models_conv = cross_validate(df, 
                                models = c("am~cyl+gear","am~mpg", 
                                           "am~mpg+cyl", "am~mpg+cyl+wt"),
                                family = 'binomial')

models_conv

# Check convergence warnings
models_conv$`Convergence Warnings`
```

We can also exclude models that didn't converge on all folds from the output by setting 'rmnc' (remove non-converged) to TRUE. 

```{r}
models_conv = cross_validate(df, 
                             models = c("am~cyl+gear","am~mpg", 
                                        "am~mpg+cyl", "am~mpg+cyl+wt"),
                             family = 'binomial',
                             rmnc = TRUE)

models_conv

```



